<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Kaurin&#39;s GitHub Blog</title>
    <description>Welcome to my paste dump!
</description>
    <link>https://kaurin.github.io/</link>
    <atom:link href="https://kaurin.github.io/feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Sun, 27 Dec 2015 01:58:37 +0000</pubDate>
    <lastBuildDate>Sun, 27 Dec 2015 01:58:37 +0000</lastBuildDate>
    <generator>Jekyll v2.4.0</generator>
    
      <item>
        <title>CFN + ASG + LifeCycle Hooks</title>
        <description>&lt;h2 id=&quot;problem&quot;&gt;Problem&lt;/h2&gt;

&lt;p&gt;When you use CFN to provision an ASG with LifeCycle events which trigger on instance launches, the issue is that CFN first creates an ASG. ASG immediately starts spinning up instances based on ASG settings. LifeCycle hooks get created usually with some delay.&lt;/p&gt;

&lt;p&gt;This causes some instances to get launched without being “monitored” by the “launch” lifecylce hooks.&lt;/p&gt;

&lt;h2 id=&quot;solution&quot;&gt;Solution&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;ASG set to 0/0/0 in CFN&lt;/li&gt;
  &lt;li&gt;Custom resource which has “DependsOn” lifecycle resource for instance launches&lt;/li&gt;
  &lt;li&gt;Lambda function which can perform “updateAutoScalingGroup”(called by custom resource)&lt;/li&gt;
  &lt;li&gt;IAM execution role for lambda (as/updateAutoScalingGroup)&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;requirements&quot;&gt;Requirements&lt;/h2&gt;

&lt;p&gt;Region which supports Lambda&lt;/p&gt;

&lt;h2 id=&quot;cfn-command-to-create-stack&quot;&gt;CFN command to create stack&lt;/h2&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ruby&quot; data-lang=&quot;ruby&quot;&gt;&lt;span class=&quot;n&quot;&gt;cloudformation&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stack&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ASG&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;LifeCycle&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;DelayFirstInstance&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cform&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;capabilities&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;CAPABILITY_IAM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parameters&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ASG&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;LifeCycle&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;DelayFirstInstance&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stack&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;MyStackName123&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;You can just change “create-stack” -&amp;gt; “update-stack” if you want to update the stack instead of create a new one.&lt;/p&gt;

&lt;h2 id=&quot;files&quot;&gt;Files&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://kaurin.github.io/assets/2015-12-27-cfn-asg-post/ASG-LifeCycle-DelayFirstInstance.cform&quot;&gt;Template&lt;/a&gt; | &lt;a href=&quot;https://kaurin.github.io/assets/2015-12-27-cfn-asg-post/ASG-LifeCycle-DelayFirstInstance.params&quot;&gt;Parameters&lt;/a&gt; | &lt;a href=&quot;https://kaurin.github.io/assets/2015-12-27-cfn-asg-post/AsgIncrease.zip&quot;&gt;Lambda function&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;note&quot;&gt;Note&lt;/h2&gt;

&lt;p&gt;You need to upload the lambda function zip to an S3 bucket, and then provide bucket name / object name in parameters&lt;/p&gt;
</description>
        <pubDate>Sun, 27 Dec 2015 00:44:34 +0000</pubDate>
        <link>https://kaurin.github.io/aws/2015/12/27/test.html</link>
        <guid isPermaLink="true">https://kaurin.github.io/aws/2015/12/27/test.html</guid>
        
        <category>aws,cfn,autoscaling,asg</category>
        
        
        <category>aws</category>
        
      </item>
    
  </channel>
</rss>
