<!DOCTYPE html>
<html>

<head>
    <!-- HTTPS redirect-->
    <script>
    // Don't force https when serving the website locally
    if (!((window.location.host.startsWith("localhost")) || (window.location.host.startsWith("127.0"))) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
    </script>
</head>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>EC2 + Ansible Setup</title>
    <meta name="description" content="Welcome to my paste dump!
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://kaurin.github.io/aws/2015/12/27/ansible-ec2.html">
</head>


<body>
    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Kaurin's Paste Dump</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>

    <div class="page-content">
        <div class="wrapper">
            <div class="post">

  <header class="post-header">
    <h1 class="post-title">EC2 + Ansible Setup</h1>
    <p class="post-meta">Dec 27, 2015</p>
  </header>

  <article class="post-content">
    <h2 id="overview">Overview</h2>

<p>As the name of this website states, this is just my pastedump. By no means is this an all-round best-practice guide. If your use case is to have a light touch on an ansible-master in EC2 wihtout the need to implement ‘ansible-pull’, then I’d consider this an OK guide.</p>

<p>This is what the setup will look like:</p>

<ul>
  <li>1 control instance in EC2 called ansible-master (public subnet)</li>
  <li>Multiple target instances in EC2 (private subnet/s)</li>
  <li>Target instances will belong to different stacks/roles. This will be controlled via EC2 tags</li>
  <li>No credentials wil be stored on the master instance. We’ll use SSH SendEnv and AgentForward capabilities.</li>
</ul>

<h2 id="aws">AWS</h2>

<h3 id="iam">IAM</h3>

<p>Create an “ansible-master” user which has permissions to Describe* on RDS, EC2 and ElastiCache. Download the credentials. You will use them later in <strong>~/.bashrc</strong></p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;ec2:Describe*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;elasticache:Describe*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rds:Describe*&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;*&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span></code></pre></div>

<h3 id="ssh-keys">SSH Keys</h3>

<p>Create or import “ansible-master” and “ansible-controller” SSH keys in the EC2 console.</p>

<ul>
  <li>ansible-controller = Workstation -&gt; Ansible master instance</li>
  <li>ansible-target = Workstation -(ForwardAgent)-&gt; Ansible master -&gt; Ansible targets</li>
</ul>

<p>This setup allows us to keep all credentials (EC2/SSH) on our local workstation, and just forward those credentials to the “ansible-master” instance when we SSH into it. This suits only my specific use case where I have very little automation on the Ansible side.</p>

<h3 id="launch-target-instances">Launch target instances</h3>

<p>We will test them later, for now, launch them:</p>

<ul>
  <li>Into private subnets</li>
  <li>SSH key: ansible-target</li>
  <li>Tag: AnsibleSlave=True</li>
  <li>Tag: Role=Web</li>
  <li>Tag: Stack=Prod</li>
</ul>

<p>The Role/Stack are optional, but useful if you want to play around with how you can limit execution based on EC2 tags. If you decide to go with these optional tags, spin up multiple instances and change up the Role and Stack tags among them.</p>

<p>You never need to know any other EC2 instance details except for the tags. Ansible will figure out the private IPs and other info based on said tags.</p>

<h2 id="workstation">Workstation</h2>

<h3 id="sshconfig">~/.ssh/config</h3>

<div class="highlight"><pre><code class="language-text" data-lang="text">Host ansible
    HostName xx.xx.xx.xx
    User ec2-user
    SendEnv AWS_ACCESS_KEY_ID
    SendEnv AWS_SECRET_ACCESS_KEY 
    IdentityFile ~/.ssh/ansible-controller
    ForwardAgent yes</code></pre></div>

<h3 id="bashrc">~/.bashrc</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">alias </span><span class="nv">ansconn</span><span class="o">=</span><span class="s1">&#39;AWS_ACCESS_KEY_ID=&quot;SECRET&quot; AWS_SECRET_ACCESS_KEY=&quot;ACCESS&quot; ssh ansible&#39;</span></code></pre></div>

<h2 id="ansible-master-instance">Ansible master instance</h2>

<h3 id="ssh-daemon">SSH Daemon</h3>

<p>We want to be able to accept the environment variables from the SSH client from our workstation. In order to make this happen, we need to change the sshd_config</p>

<h4 id="etcsshsshdconfig">/etc/ssh/sshd_config</h4>

<div class="highlight"><pre><code class="language-text" data-lang="text">AcceptEnv AWS_ACCESS_KEY_ID
AcceptEnv AWS_SECRET_ACCESS_KEY</code></pre></div>

<h3 id="ansible-installation">Ansible installation</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo pip install ansible
sudo pip install ansible --upgrade</code></pre></div>

<p>The default ansible hosts file is plain-text and consists of your hosts and host groups. In EC2, it makes more sense to use the EC2 inventory hosts script which replaces the hosts file. This hosts file also requires the ec2.ini file on which we’ll touch on in a short bit.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo wget <span class="s1">&#39;https://raw.github.com/ansible/ansible/devel/contrib/inventory/ec2.py&#39;</span> -O /etc/ansible/hosts
chmod +x /etc/ansible/hosts
sudo wget <span class="s1">&#39;https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/ec2.ini&#39;</span> -O /etc/ansible/ec2.ini</code></pre></div>

<h3 id="ec2ini">ec2.ini</h3>

<p>It’s time to change ec2.ini settings.
Note: Adjust this on your own accord. The file is nicely commented. I’ll note some of the settings I adjusted</p>

<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="k">[ec2]</span>
<span class="na">regions</span> <span class="o">=</span> <span class="s">eu-central-1</span>
<span class="na">regions_exclude</span> <span class="o">=</span> <span class="s">us-gov-west-1,cn-north-1</span>
<span class="na">destination_variable</span> <span class="o">=</span> <span class="s">private_dns_name</span>
<span class="na">vpc_destination_variable</span> <span class="o">=</span> <span class="s">private_ip_address</span>
<span class="na">rds</span> <span class="o">=</span> <span class="s">False</span>
<span class="na">elasticache</span> <span class="o">=</span> <span class="s">False</span>
<span class="na">cache_max_age</span> <span class="o">=</span> <span class="s">0</span>
<span class="na">instance_filters</span> <span class="o">=</span> <span class="s">tag:AnsibleSlave=True</span></code></pre></div>

<p>The last option might be the most significant one. Only instances with this tag will be considered as Ansible-controllable</p>

<h2 id="time-to-test">Time to test</h2>

<ul>
  <li>SSH into the instance by running <strong>ansconn</strong>, which is based on the alias we created in <strong>~/.bashrc</strong></li>
  <li>Run: <code>ansible all -m ping</code></li>
  <li>Run: <code>ansible tag_Role_Web -m ping</code></li>
</ul>

<p>If you implement playbooks, you can fine-grain your prod/stage stacks with a layered approach, but this is exaplined in Ansible docs.</p>

  </article>

</div>

        </div>
    </div>
    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Kaurin's Paste Dump</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Kaurin's Paste Dump</li>
          <li><a href="mailto:kaurin@users.noreply.github.com">kaurin@users.noreply.github.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/kaurin">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">kaurin</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/kaurin011">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">kaurin011</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Welcome to my paste dump!
</p>
      </div>
    </div>

  </div>

</footer>

</body>

</html>
